@page "/scrape"
@using CarComparator.Shared.Contracts
@using CarComparator.Shared.DTOs
@inject ICarApi CarApi

<PageTitle>Scrape Cars</PageTitle>

<h1>Scrape Car Listings</h1>
<p>Enter a URL from a car listing website to scrape and index car data.</p>

<div class="row">
    <div class="col-md-8">
        <div class="input-group mb-3">
            <input class="form-control" placeholder="https://example-car-site.com/listings" @bind="sourceUrl" />
            <button class="btn btn-primary" @onclick="StartScrape" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    <span> Scraping...</span>
                }
                else
                {
                    <span>Scrape</span>
                }
            </button>
        </div>

        @if (successMessage != null)
        {
            <div class="alert alert-success">@successMessage</div>
        }
        @if (errorMessage != null)
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
    </div>
</div>

<div class="mt-4">
    <h5>How it works</h5>
    <ol>
        <li>Enter the URL of a car listing page.</li>
        <li>The backend will use Playwright to navigate to the page and extract car information.</li>
        <li>The extracted cars will be indexed into the database.</li>
        <li>Browse the indexed cars on the <a href="/cars">Cars</a> page.</li>
    </ol>
</div>

@code {
    private string? sourceUrl;
    private bool isLoading = false;
    private string? successMessage;
    private string? errorMessage;

    private async Task StartScrape()
    {
        if (string.IsNullOrWhiteSpace(sourceUrl))
        {
            errorMessage = "Please enter a valid URL.";
            return;
        }

        isLoading = true;
        successMessage = null;
        errorMessage = null;

        try
        {
            await CarApi.ScrapeAsync(new ScrapeRequestDto { SourceUrl = sourceUrl });
            successMessage = "Scraping completed. Cars have been indexed.";
            sourceUrl = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Scraping failed: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
